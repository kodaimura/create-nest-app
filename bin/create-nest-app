#!/bin/bash

APP_NAME=$1

CURRENT_DIR=$(pwd)
SELF_DIR=$(cd $(dirname $0); pwd)

mkdir $CURRENT_DIR/$APP_NAME
cd $CURRENT_DIR/$APP_NAME

git init


#frontend (React)


npx create-react-app frontend --template typescript

cd frontend

rm public/*.png
rm public/favicon.ico
rm public/manifest.json
rm public/robots.txt

rm src/*css
rm src/setupTests.ts 
rm src/logo.svg
rm src/App.test.tsx
rm src/App.tsx

cp -r $SELF_DIR/nest-react/frontend/src/apis src
cp -r $SELF_DIR/nest-react/frontend/src/components src
cp -r $SELF_DIR/nest-react/frontend/src/routes src
cp -r $SELF_DIR/nest-react/frontend/src/types src
cp -r $SELF_DIR/nest-react/frontend/src/utils src
cp -r $SELF_DIR/nest-react/frontend/src/utils src
cp $SELF_DIR/nest-react/frontend/src/App.tsx src
cp $SELF_DIR/nest-react/frontend/src/index.css src

open ./public/index.html -a /Applications/Sublime\ Text.app

npm i react-router-dom
npm i --save-dev @types/react-router-dom

npm i @mui/material @emotion/react @emotion/styled
npm i @mui/icons-material

npm i http-proxy-middleware
cp $SELF_DIR/nest-react/frontend/src/setupProxy.js src

sed 's/react-scripts build/GENERATE_SOURCEMAP=false react-scripts build/g' package.json
npm run build

cd ../



#backend (Nest)


nest new backend

cd backend

yes | rm -r src
cp -r $SELF_DIR/nest-react/backend/src .

cat <<EOF > src/constants.ts
export const appname = "$APP_NAME"

export const dbname = "$APP_NAME.db"
EOF

cat <<EOF >> .gitignore

# ELSE
.env
*.db
EOF

npm i @nestjs/passport passport passport-local @nestjs/jwt passport-jwt
npm i --save-dev @types/passport-local @types/passport-jwt

npm i class-validator
npm i class-transformer

npm i @nestjs/config

npm i @nestjs/typeorm typeorm sqlite3

npm i @nestjs/serve-static

npm i cookie-parser


echo ""
echo "Please enter JWT_SECRET_KEY:"
read JWT_SECRET_KEY
echo ""
echo "JWT_SECRET_KEY=$JWT_SECRET_KEY" > .env

yes | rm -r .git


open http://localhost:3000

nest start
